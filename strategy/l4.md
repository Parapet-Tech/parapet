# L4: Multi-Turn Risk Scoring

L4 detects multi-turn injection behavior across conversation history.

It scores conversation-level risk from cross-turn pattern matches and behavioral signals.

## Config

```yaml
layers:
  L4:
    mode: shadow
    risk_threshold: 0.7
    escalation_bonus: 0.2
    resampling_bonus: 0.7
    persistence_factor: 0.45
    diversity_factor: 0.15
    min_user_turns: 2
```

## How L4 scores

L4 scans user and tool turns, then computes:

1. peak turn risk
2. persistence term (matched-turn ratio)
3. diversity bonus (distinct category count)
4. escalation bonus (strictly increasing late-turn scores)
5. repetition/resampling bonus (consecutive high Jaccard similarity on long user turns)

Final score is clamped to `[0.0, 1.0]`.

## Modes

1. `block`: block when `risk_score >= risk_threshold`.
2. `shadow`: log detection without blocking.

## Notes on coverage

L4 is designed for multi-turn prompt-injection patterns, not generic harmful-content requests.

From `implement/evals/l4.md`, representative results reported for injection-focused evaluation:

1. around `90.8%` recall at about `1.20%` FPR in the paper setting
2. `75.1%` recall on WildJailbreak attacks in later broader evaluation

Use `shadow` mode for calibration before enforcing in `block` mode.
